<template>
	<!-- #ifdef APP -->
	<scroll-view class="page-container">
	<!-- #endif -->
		<view class="home-page">
			<!-- å¤´éƒ¨æ¬¢è¿åŒº -->
			<view class="welcome-section">
				<view class="welcome-content">
					<text class="welcome-title">MPM å·¥è‰ºé¢„è§ˆç³»ç»Ÿ</text>
					<text class="welcome-subtitle">ç¦»çº¿ç‰ˆ Â· è½¦é—´ä¸“ç”¨</text>
				</view>
				<image class="logo" src="/static/logo.png"></image>
			</view>
			
			<!-- ç»Ÿè®¡å¡ç‰‡ -->
			<view class="stats-cards">
				<view class="stat-card">
					<text class="stat-value">{{ processCount }}</text>
					<text class="stat-label">å·¥è‰ºæ€»æ•°</text>
				</view>
				<view class="stat-card stat-card-last">
					<text class="stat-value">{{ lastImportTime }}</text>
					<text class="stat-label">æœ€è¿‘å¯¼å…¥</text>
				</view>
			</view>
			
			<!-- å¿«æ·å…¥å£ -->
			<view class="quick-actions">
				<view class="action-card" @click="goToProcessList">
					<view class="action-icon-container" style="background-color: #e3f2fd;">
						<text class="action-icon">ğŸ“‹</text>
					</view>
					<view class="action-info">
						<text class="action-title">å·¥è‰ºåˆ—è¡¨</text>
						<text class="action-desc">æµè§ˆæ‰€æœ‰å·¥è‰ºæ•°æ®</text>
					</view>
					<text class="action-arrow">â†’</text>
				</view>
				
				<view class="action-card" @click="goToImport">
					<view class="action-icon-container" style="background-color: #e8f5e9;">
						<text class="action-icon">ğŸ“¦</text>
					</view>
					<view class="action-info">
						<text class="action-title">æ•°æ®å¯¼å…¥</text>
						<text class="action-desc">å¯¼å…¥MPMæ•°æ®åŒ…</text>
					</view>
					<text class="action-arrow">â†’</text>
				</view>
				
				<view class="action-card" @click="goToSettings">
					<view class="action-icon-container" style="background-color: #ede7f6;">
						<text class="action-icon">âš™ï¸</text>
					</view>
					<view class="action-info">
						<text class="action-title">ç³»ç»Ÿè®¾ç½®</text>
						<text class="action-desc">ç¼“å­˜æ¸…ç†ä¸ç®¡ç†</text>
					</view>
					<text class="action-arrow">â†’</text>
				</view>
			</view>
			
			<!-- æœ€è¿‘æŸ¥çœ‹ -->
			<view class="section" v-if="recentProcesses.length > 0">
				<view class="section-header">
					<text class="section-title">æœ€è¿‘æŸ¥çœ‹</text>
				</view>
				
				<view class="recent-list">
					<view 
						class="recent-item" 
						v-for="(item, index) in recentProcesses" 
						:key="index"
						@click="goToDetail(item.id)"
					>
						<view class="recent-info">
							<text class="recent-name">{{ item.name }}</text>
							<text class="recent-code">{{ item.code }}</text>
						</view>
						<text class="recent-arrow">â†’</text>
					</view>
				</view>
			</view>
			
			<!-- ç³»ç»Ÿä¿¡æ¯ -->
			<view class="system-info">
				<text class="system-text">ç‰ˆæœ¬: 1.0.0</text>
				<text class="system-text">ç¦»çº¿å·¥è‰ºé¢„è§ˆç³»ç»Ÿ</text>
			</view>
		</view>
	<!-- #ifdef APP -->
	</scroll-view>
	<!-- #endif -->
</template>

<script lang="uts">
	import { ProcessListItem } from '@/types/process'
	import { getProcessCount } from '@/services/processService'
	import { initDatabase } from '@/services/database'
	
	/**
	 * æœ€è¿‘æŸ¥çœ‹çš„å·¥è‰ºé¡¹ç±»å‹
	 */
	type RecentProcess = {
		id: string
		name: string
		code: string
	}
	
	export default {
		data() {
			return {
				// å·¥è‰ºæ€»æ•°
				processCount: 0,
				
				// æœ€è¿‘å¯¼å…¥æ—¶é—´
				lastImportTime: '-',
				
				// æœ€è¿‘æŸ¥çœ‹çš„å·¥è‰º
				recentProcesses: [] as RecentProcess[]
			}
		},
		
		onShow() {
			this.loadData()
		},
		
		methods: {
			/**
			 * åŠ è½½æ•°æ®
			 */
			loadData() {
				initDatabase()
					.then(() => {
						return getProcessCount()
					})
					.then((count: number) => {
						this.processCount = count
					})
					.catch((e: Error) => {
						console.error('åŠ è½½æ•°æ®å¤±è´¥ï¼š', e.message)
					})
				
				// åŠ è½½æœ€è¿‘æŸ¥çœ‹è®°å½•ï¼ˆä»æœ¬åœ°å­˜å‚¨ï¼‰
				this.loadRecentProcesses()
			},
			
			/**
			 * åŠ è½½æœ€è¿‘æŸ¥çœ‹è®°å½•
			 */
			loadRecentProcesses() {
				try {
					const recentStr = uni.getStorageSync('recent_processes') as string
					if (recentStr != '') {
						this.recentProcesses = JSON.parse(recentStr) as RecentProcess[]
					}
				} catch (e: any) {
					console.error('åŠ è½½æœ€è¿‘è®°å½•å¤±è´¥ï¼š', JSON.stringify(e))
				}
			},
			
			/**
			 * è·³è½¬åˆ°å·¥è‰ºåˆ—è¡¨
			 */
			goToProcessList() {
				uni.switchTab({
					url: '/pages/process/list'
				})
			},
			
			/**
			 * è·³è½¬åˆ°æ•°æ®å¯¼å…¥
			 */
			goToImport() {
				uni.switchTab({
					url: '/pages/import/import'
				})
			},
			
			/**
			 * è·³è½¬åˆ°è®¾ç½®é¡µé¢
			 */
			goToSettings() {
				uni.navigateTo({
					url: '/pages/settings/settings'
				})
			},
			
			/**
			 * è·³è½¬åˆ°å·¥è‰ºè¯¦æƒ…
			 */
			goToDetail(processId: string) {
				uni.navigateTo({
					url: '/pages/process/detail?id=' + processId
				})
			}
		}
	}
</script>

<style>
	.page-container {
		flex: 1;
		background-color: #f5f6f7;
	}
	
	.home-page {
		flex-direction: column;
		padding: 16px;
	}
	
	/* æ¬¢è¿åŒº */
	.welcome-section {
		flex-direction: row;
		justify-content: space-between;
		align-items: center;
		background-color: #007aff;
		border-radius: 16px;
		padding: 24px 20px;
		margin-bottom: 16px;
	}
	
	.welcome-content {
		flex-direction: column;
	}
	
	.welcome-title {
		font-size: 22px;
		font-weight: bold;
		color: #ffffff;
	}
	
	.welcome-subtitle {
		font-size: 14px;
		color: rgba(255, 255, 255, 0.8);
		margin-top: 4px;
	}
	
	.logo {
		width: 60px;
		height: 60px;
		border-radius: 12px;
	}
	
	/* ç»Ÿè®¡å¡ç‰‡ */
	.stats-cards {
		flex-direction: row;
		margin-bottom: 16px;
	}
	
	.stat-card {
		flex: 1;
		background-color: #ffffff;
		border-radius: 12px;
		padding: 20px;
		margin-right: 12px;
		align-items: center;
		flex-direction: column;
	}
	
	.stat-card-last {
		margin-right: 0;
	}
	
	.stat-value {
		font-size: 28px;
		font-weight: bold;
		color: #007aff;
	}
	
	.stat-label {
		font-size: 13px;
		color: #999999;
		margin-top: 4px;
	}
	
	/* å¿«æ·å…¥å£ */
	.quick-actions {
		flex-direction: column;
		margin-bottom: 16px;
	}
	
	.action-card {
		flex-direction: row;
		align-items: center;
		background-color: #ffffff;
		border-radius: 12px;
		padding: 16px;
		margin-bottom: 12px;
	}
	
	.action-icon-container {
		width: 48px;
		height: 48px;
		border-radius: 12px;
		align-items: center;
		justify-content: center;
		margin-right: 16px;
	}
	
	.action-icon {
		font-size: 24px;
	}
	
	.action-info {
		flex: 1;
		flex-direction: column;
	}
	
	.action-title {
		font-size: 16px;
		font-weight: bold;
		color: #333333;
	}
	
	.action-desc {
		font-size: 13px;
		color: #999999;
		margin-top: 2px;
	}
	
	.action-arrow {
		font-size: 18px;
		color: #cccccc;
	}
	
	/* åˆ†åŒº */
	.section {
		margin-bottom: 16px;
	}
	
	.section-header {
		padding: 8px 4px;
	}
	
	.section-title {
		font-size: 16px;
		font-weight: bold;
		color: #333333;
	}
	
	/* æœ€è¿‘æŸ¥çœ‹ */
	.recent-list {
		background-color: #ffffff;
		border-radius: 12px;
		overflow: hidden;
	}
	
	.recent-item {
		flex-direction: row;
		align-items: center;
		padding: 14px 16px;
		border-bottom-width: 1px;
		border-bottom-style: solid;
		border-bottom-color: #f0f0f0;
	}
	
	.recent-info {
		flex: 1;
		flex-direction: column;
	}
	
	.recent-name {
		font-size: 15px;
		color: #333333;
	}
	
	.recent-code {
		font-size: 12px;
		color: #999999;
		margin-top: 2px;
	}
	
	.recent-arrow {
		font-size: 14px;
		color: #cccccc;
	}
	
	/* ç³»ç»Ÿä¿¡æ¯ */
	.system-info {
		align-items: center;
		padding: 20px;
	}
	
	.system-text {
		font-size: 12px;
		color: #cccccc;
		margin-bottom: 4px;
	}
</style>