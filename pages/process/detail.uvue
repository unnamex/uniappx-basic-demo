<template>
	<!-- #ifdef APP -->
	<scroll-view class="page-container">
	<!-- #endif -->
		<view class="detail-page">
			<!-- åŸºæœ¬ä¿¡æ¯å¡ç‰‡ -->
			<view class="info-card">
				<view class="card-header">
					<text class="process-code">{{ processInfo?.code ?? '' }}</text>
					<view class="status-tag" :class="getStatusClass(processInfo?.status ?? '')">
						<text class="status-text">{{ processInfo?.status ?? '' }}</text>
					</view>
				</view>
				
				<text class="process-name">{{ processInfo?.name ?? '' }}</text>
				
				<view class="info-grid">
					<view class="info-item">
						<text class="info-label">äº§å“åç§°</text>
						<text class="info-value">{{ processInfo?.product?.name ?? '-' }}</text>
					</view>
					<view class="info-item">
						<text class="info-label">äº§å“å‹å·</text>
						<text class="info-value">{{ processInfo?.product?.model ?? '-' }}</text>
					</view>
					<view class="info-item">
						<text class="info-label">ç‰ˆæœ¬</text>
						<text class="info-value">{{ processInfo?.version ?? '-' }}</text>
					</view>
					<view class="info-item">
						<text class="info-label">å·¥è‰ºæ­¥éª¤</text>
						<text class="info-value">{{ processInfo?.steps?.length ?? 0 }} ä¸ª</text>
					</view>
				</view>
				
				<view class="time-info">
					<text class="time-text">åˆ›å»ºï¼š{{ formatTime(processInfo?.createdAt ?? '') }}</text>
					<text class="time-text">æ›´æ–°ï¼š{{ formatTime(processInfo?.updatedAt ?? '') }}</text>
				</view>
			</view>
			
			<!-- å·¥è‰ºæ­¥éª¤åˆ—è¡¨ -->
			<view class="section">
				<view class="section-header">
					<text class="section-title">å·¥è‰ºæ­¥éª¤</text>
					<text class="section-count">å…± {{ processInfo?.steps?.length ?? 0 }} æ­¥</text>
				</view>
				
				<view class="steps-list" v-if="processInfo != null && processInfo.steps.length > 0">
					<process-step
						v-for="(step, index) in processInfo.steps" 
						:key="index"
						:step="step"
						:expanded="expandedSteps.includes(index)"
						:resourceBasePath="resourceBasePath"
						@toggle="onStepToggle(index, $event)"
					></process-step>
				</view>
			</view>
			
			<!-- é™„ä»¶åˆ—è¡¨ -->
			<view class="section" v-if="processInfo != null && processInfo.attachments.length > 0">
				<view class="section-header">
					<text class="section-title">ç›¸å…³é™„ä»¶</text>
				</view>
				
				<view class="attachment-list">
					<view 
						class="attachment-item" 
						v-for="(attachment, aIdx) in processInfo.attachments" 
						:key="aIdx"
						@click="openAttachment(attachment)"
					>
						<text class="attachment-icon">{{ getAttachmentIcon(attachment.type) }}</text>
						<text class="attachment-name">{{ attachment.name }}</text>
						<text class="attachment-arrow">â†’</text>
					</view>
				</view>
			</view>
		</view>
	<!-- #ifdef APP -->
	</scroll-view>
	<!-- #endif -->
</template>

<script lang="uts">
	import { ProcessInfo, ProcessAttachment } from '@/types/process'
	import { getProcessDetail } from '@/services/processService'
	import { initDatabase } from '@/services/database'
	
	export default {
		data() {
			return {
				// å·¥è‰ºID
				processId: '',
				
				// å·¥è‰ºä¿¡æ¯
				processInfo: null as ProcessInfo | null,
				
				// å±•å¼€çš„æ­¥éª¤ç´¢å¼•åˆ—è¡¨
				expandedSteps: [] as number[],
				
				// èµ„æºæ–‡ä»¶åŸºç¡€è·¯å¾„
				resourceBasePath: ''
			}
		},
		
		onLoad(options: any) {
			if (options['id'] != null) {
				this.processId = options['id'] as string
			}
			
			// è®¾ç½®èµ„æºè·¯å¾„
			// #ifdef APP-ANDROID || APP-HARMONY
			this.resourceBasePath = uni.env.USER_DATA_PATH + '/mpm_resources/'
			// #endif
			
			this.loadProcessDetail()
		},
		
		methods: {
			/**
			 * åŠ è½½å·¥è‰ºè¯¦æƒ…
			 */
			loadProcessDetail() {
				if (this.processId == '') {
					uni.showToast({
						title: 'å‚æ•°é”™è¯¯',
						icon: 'none'
					})
					return
				}
				
				uni.showLoading({ title: 'åŠ è½½ä¸­...' })
				
				initDatabase()
					.then(() => {
						return getProcessDetail(this.processId)
					})
					.then((info: ProcessInfo | null) => {
						uni.hideLoading()
						
						if (info != null) {
							this.processInfo = info
							
							// è®¾ç½®å¯¼èˆªæ æ ‡é¢˜
							uni.setNavigationBarTitle({
								title: info.name
							})
						} else {
							uni.showToast({
								title: 'å·¥è‰ºä¸å­˜åœ¨',
								icon: 'none'
							})
						}
					})
					.catch((e: Error) => {
						uni.hideLoading()
						console.error('åŠ è½½å·¥è‰ºè¯¦æƒ…å¤±è´¥ï¼š', e.message)
						uni.showToast({
							title: 'åŠ è½½å¤±è´¥',
							icon: 'none'
						})
					})
			},
			
			/**
			 * æ­¥éª¤å±•å¼€åˆ‡æ¢å›è°ƒ
			 */
			onStepToggle(index: number, expanded: boolean) {
				const idx = this.expandedSteps.indexOf(index)
				if (expanded) {
					if (idx == -1) {
						this.expandedSteps.push(index)
					}
				} else {
					if (idx > -1) {
						this.expandedSteps.splice(idx, 1)
					}
				}
			},
			
			/**
			 * è·å–èµ„æºæ–‡ä»¶è·¯å¾„
			 */
			getResourcePath(fileName: string): string {
				return this.resourceBasePath + fileName
			},
			
			/**
			 * æ‰“å¼€é™„ä»¶
			 */
			openAttachment(attachment: ProcessAttachment) {
				const fullPath = this.getResourcePath(attachment.path)
				
				// #ifdef APP-ANDROID || APP-HARMONY
				uni.openDocument({
					filePath: fullPath,
					showMenu: true,
					fail: (err: any) => {
						uni.showToast({
							title: 'æ— æ³•æ‰“å¼€æ–‡ä»¶',
							icon: 'none'
						})
					}
				})
				// #endif
				
				// #ifdef WEB
				window.open(fullPath, '_blank')
				// #endif
			},
			
			/**
			 * è·å–é™„ä»¶å›¾æ ‡
			 */
			getAttachmentIcon(type: string): string {
				if (type == 'drawing') {
					return 'ğŸ“'
				} else if (type == 'document') {
					return 'ğŸ“„'
				} else if (type == 'image') {
					return 'ğŸ–¼ï¸'
				} else if (type == 'video') {
					return 'ğŸ¬'
				} else {
					return 'ğŸ“'
				}
			},
			
			/**
			 * è·å–çŠ¶æ€æ ·å¼ç±»
			 */
			getStatusClass(status: string): string {
				if (status == 'å·²å‘å¸ƒ') {
					return 'status-published'
				} else if (status == 'è‰ç¨¿') {
					return 'status-draft'
				} else {
					return 'status-default'
				}
			},
			
			/**
			 * æ ¼å¼åŒ–æ—¶é—´
			 */
			formatTime(isoTime: string): string {
				if (isoTime == '') {
					return '-'
				}
				const date = new Date(isoTime)
				const year = date.getFullYear()
				const month = (date.getMonth() + 1).toString().padStart(2, '0')
				const day = date.getDate().toString().padStart(2, '0')
				return `${year}-${month}-${day}`
			}
		}
	}
</script>

<style>
	.page-container {
		flex: 1;
		background-color: #f5f6f7;
	}
	
	.detail-page {
		flex-direction: column;
		padding: 12px;
	}
	
	/* ä¿¡æ¯å¡ç‰‡ */
	.info-card {
		background-color: #ffffff;
		border-radius: 12px;
		padding: 20px;
		margin-bottom: 12px;
		flex-direction: column;
	}
	
	.card-header {
		flex-direction: row;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 12px;
	}
	
	.process-code {
		font-size: 14px;
		color: #666666;
	}
	
	.status-tag {
		padding: 4px 12px;
		border-radius: 4px;
	}
	
	.status-published {
		background-color: #e8f5e9;
	}
	
	.status-draft {
		background-color: #fff3e0;
	}
	
	.status-default {
		background-color: #f5f5f5;
	}
	
	.status-text {
		font-size: 12px;
		color: #333333;
	}
	
	.process-name {
		font-size: 20px;
		font-weight: bold;
		color: #333333;
		margin-bottom: 16px;
	}
	
	.info-grid {
		flex-direction: row;
		flex-wrap: wrap;
		margin-bottom: 16px;
	}
	
	.info-item {
		width: 50%;
		flex-direction: column;
		margin-bottom: 12px;
	}
	
	.info-label {
		font-size: 12px;
		color: #999999;
		margin-bottom: 4px;
	}
	
	.info-value {
		font-size: 14px;
		color: #333333;
	}
	
	.time-info {
		flex-direction: row;
		justify-content: space-between;
		border-top-width: 1px;
		border-top-style: solid;
		border-top-color: #f0f0f0;
		padding-top: 12px;
	}
	
	.time-text {
		font-size: 12px;
		color: #999999;
	}
	
	/* åˆ†åŒº */
	.section {
		margin-bottom: 12px;
	}
	
	.section-header {
		flex-direction: row;
		justify-content: space-between;
		align-items: center;
		padding: 12px 4px;
	}
	
	.section-title {
		font-size: 16px;
		font-weight: bold;
		color: #333333;
	}
	
	.section-count {
		font-size: 12px;
		color: #999999;
	}
	
	/* æ­¥éª¤åˆ—è¡¨å®¹å™¨ */
	.steps-list {
		flex-direction: column;
	}
	
	/* é™„ä»¶åˆ—è¡¨ */
	.attachment-list {
		background-color: #ffffff;
		border-radius: 12px;
		overflow: hidden;
	}
	
	.attachment-item {
		flex-direction: row;
		align-items: center;
		padding: 14px 16px;
		border-bottom-width: 1px;
		border-bottom-style: solid;
		border-bottom-color: #f0f0f0;
	}
	
	.attachment-icon {
		font-size: 20px;
		margin-right: 12px;
	}
	
	.attachment-name {
		flex: 1;
		font-size: 14px;
		color: #333333;
	}
	
	.attachment-arrow {
		font-size: 14px;
		color: #cccccc;
	}
</style>
