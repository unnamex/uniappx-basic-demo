<template>
	<!-- #ifdef APP -->
	<scroll-view class="page-container" @scrolltolower="loadMore">
	<!-- #endif -->
		<view class="list-page">
			<!-- æœç´¢æ  -->
			<view class="search-bar">
				<view class="search-input-container">
					<text class="search-icon">ğŸ”</text>
					<input 
						class="search-input" 
						type="text" 
						placeholder="æœç´¢å·¥è‰ºåç§°æˆ–ç¼–å·"
						:value="keyword"
						@input="handleSearchInput"
						@confirm="handleSearch"
					/>
					<text class="search-clear" v-if="keyword != ''" @click="handleClearSearch">âœ•</text>
				</view>
			</view>
			
			<!-- ç»Ÿè®¡ä¿¡æ¯ -->
			<view class="stats-bar">
				<text class="stats-text">å…± {{ totalCount }} æ¡å·¥è‰º</text>
			</view>
			
			<!-- å·¥è‰ºåˆ—è¡¨ -->
			<view class="process-list" v-if="processList.length > 0">
				<process-card 
					v-for="(item, index) in processList" 
					:key="item.id"
					:item="item"
					@click="handleCardClick"
				></process-card>
			</view>
			
			<!-- ç©ºçŠ¶æ€ -->
			<view class="empty-state" v-else-if="!isLoading">
				<text class="empty-icon">ğŸ“­</text>
				<text class="empty-title">æš‚æ— å·¥è‰ºæ•°æ®</text>
				<text class="empty-desc">è¯·å…ˆå¯¼å…¥å·¥è‰ºæ•°æ®åŒ…</text>
				<button class="btn-import" @click="goToImport">
					<text class="btn-text">å»å¯¼å…¥</text>
				</button>
			</view>
			
			<!-- åŠ è½½çŠ¶æ€ -->
			<view class="loading-more" v-if="isLoading">
				<text class="loading-text">åŠ è½½ä¸­...</text>
			</view>
			
			<!-- åŠ è½½å®Œæˆ -->
			<view class="load-end" v-if="!hasMore && processList.length > 0">
				<text class="load-end-text">â€”â€” å·²åŠ è½½å…¨éƒ¨ â€”â€”</text>
			</view>
		</view>
	<!-- #ifdef APP -->
	</scroll-view>
	<!-- #endif -->
</template>

<script lang="uts">
	import { ProcessListItem } from '@/types/process'
	import { PageParams, PageResult } from '@/types/common'
	import { getProcessList, getProcessCount } from '@/services/processService'
	import { initDatabase } from '@/services/database'
	
	export default {
		data() {
			return {
				// æœç´¢å…³é”®è¯
				keyword: '',
				
				// å·¥è‰ºåˆ—è¡¨
				processList: [] as ProcessListItem[],
				
				// æ€»æ•°
				totalCount: 0,
				
				// å½“å‰é¡µç 
				currentPage: 1,
				
				// æ¯é¡µæ•°é‡
				pageSize: 10,
				
				// æ˜¯å¦è¿˜æœ‰æ›´å¤š
				hasMore: true,
				
				// æ˜¯å¦æ­£åœ¨åŠ è½½
				isLoading: false
			}
		},
		
		onLoad() {
			this.initPage()
		},
		
		onShow() {
			// æ¯æ¬¡æ˜¾ç¤ºæ—¶åˆ·æ–°æ•°æ®
			this.refreshList()
		},
		
		methods: {
			/**
			 * åˆå§‹åŒ–é¡µé¢
			 */
			initPage() {
				initDatabase()
					.then(() => {
						this.loadProcessList()
					})
					.catch((e: Error) => {
						console.error('æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥ï¼š', e.message)
					})
			},
			
			/**
			 * åˆ·æ–°åˆ—è¡¨
			 */
			refreshList() {
				this.currentPage = 1
				this.hasMore = true
				this.processList = []
				this.loadProcessList()
			},
			
			/**
			 * åŠ è½½å·¥è‰ºåˆ—è¡¨
			 */
			loadProcessList() {
				if (this.isLoading || !this.hasMore) {
					return
				}
				
				this.isLoading = true
				
				const params: PageParams = {
					page: this.currentPage,
					pageSize: this.pageSize,
					keyword: this.keyword
				}
				
				getProcessList(params)
					.then((result: PageResult<ProcessListItem>) => {
						this.isLoading = false
						this.totalCount = result.total
						
						if (this.currentPage == 1) {
							this.processList = result.list
						} else {
							for (let i = 0; i < result.list.length; i++) {
								this.processList.push(result.list[i])
							}
						}
						
						// åˆ¤æ–­æ˜¯å¦è¿˜æœ‰æ›´å¤š
						if (result.list.length < this.pageSize) {
							this.hasMore = false
						}
					})
					.catch((e: Error) => {
						this.isLoading = false
						console.error('åŠ è½½å·¥è‰ºåˆ—è¡¨å¤±è´¥ï¼š', e.message)
						uni.showToast({
							title: 'åŠ è½½å¤±è´¥',
							icon: 'none'
						})
					})
			},
			
			/**
			 * åŠ è½½æ›´å¤š
			 */
			loadMore() {
				if (this.hasMore && !this.isLoading) {
					this.currentPage++
					this.loadProcessList()
				}
			},
			
			/**
			 * æœç´¢è¾“å…¥
			 */
			handleSearchInput(e: InputEvent) {
				this.keyword = (e.detail as InputEventDetail).value
			},
			
			/**
			 * æ‰§è¡Œæœç´¢
			 */
			handleSearch() {
				this.refreshList()
			},
			
			/**
			 * æ¸…é™¤æœç´¢
			 */
			handleClearSearch() {
				this.keyword = ''
				this.refreshList()
			},
			
			/**
			 * ç‚¹å‡»å·¥è‰ºå¡ç‰‡
			 */
			handleCardClick(item: ProcessListItem) {
				uni.navigateTo({
					url: '/pages/process/detail?id=' + item.id
				})
			},
			
			/**
			 * è·³è½¬åˆ°å¯¼å…¥é¡µé¢
			 */
			goToImport() {
				uni.navigateTo({
					url: '/pages/import/import'
				})
			}
		}
	}
</script>

<style>
	.page-container {
		flex: 1;
		background-color: #f5f6f7;
	}
	
	.list-page {
		flex-direction: column;
		padding: 12px;
	}
	
	/* æœç´¢æ  */
	.search-bar {
		margin-bottom: 12px;
	}
	
	.search-input-container {
		flex-direction: row;
		align-items: center;
		background-color: #ffffff;
		border-radius: 8px;
		padding: 0 12px;
		height: 44px;
	}
	
	.search-icon {
		font-size: 16px;
		margin-right: 8px;
	}
	
	.search-input {
		flex: 1;
		font-size: 14px;
		color: #333333;
	}
	
	.search-clear {
		font-size: 14px;
		color: #999999;
		padding: 4px;
	}
	
	/* ç»Ÿè®¡ä¿¡æ¯ */
	.stats-bar {
		padding: 8px 4px;
	}
	
	.stats-text {
		font-size: 12px;
		color: #999999;
	}
	
	/* å·¥è‰ºå¡ç‰‡ */
	.process-list {
		flex-direction: column;
	}

	
	/* ç©ºçŠ¶æ€ */
	.empty-state {
		flex-direction: column;
		align-items: center;
		padding: 60px 20px;
	}
	
	.empty-icon {
		font-size: 64px;
		margin-bottom: 16px;
	}
	
	.empty-title {
		font-size: 18px;
		color: #333333;
		margin-bottom: 8px;
	}
	
	.empty-desc {
		font-size: 14px;
		color: #999999;
		margin-bottom: 24px;
	}
	
	.btn-import {
		background-color: #007aff;
		border-radius: 8px;
		padding: 12px 32px;
	}
	
	.btn-text {
		color: #ffffff;
		font-size: 14px;
	}
	
	/* åŠ è½½çŠ¶æ€ */
	.loading-more {
		padding: 20px;
		align-items: center;
	}
	
	.loading-text {
		font-size: 14px;
		color: #999999;
	}
	
	.load-end {
		padding: 20px;
		align-items: center;
	}
	
	.load-end-text {
		font-size: 12px;
		color: #cccccc;
	}
</style>
