<template>
	<!-- #ifdef APP -->
	<scroll-view class="page-container">
	<!-- #endif -->
	<view class="import-page">
		<!-- é¡µé¢å¤´éƒ¨ -->
		<view class="page-header">
			<text class="page-title">æ•°æ®å¯¼å…¥</text>
		</view>
		
		<!-- æ–‡ä»¶é€‰æ‹©åŒºåŸŸ -->
		<view class="file-picker" @click="handleSelectFile" hover-class="file-picker-hover">
			<view class="file-picker-content" v-if="!packageInfo.fileName">
				<view class="icon-circle">
					<text class="file-picker-icon">ğŸ“‚</text>
				</view>
				<text class="file-picker-title">é€‰æ‹©æ•°æ®åŒ…</text>
				<text class="file-picker-hint">ç‚¹å‡»é€‰æ‹© .srd æ ¼å¼çš„æ–‡ä»¶</text>
			</view>
			<view class="file-info" v-else>
				<view class="file-icon-wrapper">
					<text class="file-type-icon">DAT</text>
				</view>
				<view class="file-details">
					<text class="file-name">{{ packageInfo.fileName }}</text>
					<text class="file-size">{{ formatFileSize(packageInfo.fileSize) }}</text>
				</view>
				<text class="file-change-badge">æ›´æ¢</text>
			</view>
		</view>
		
		<!-- æ•°æ®åŒ…ä¿¡æ¯é¢„è§ˆ -->
		<view class="card package-info" v-if="manifest != null">
			<text class="card-title">æ•°æ®åŒ…è¯¦æƒ…</text>
			<view class="info-grid">
				<view class="info-row">
					<text class="info-label">åç§°</text>
					<text class="info-value">{{ manifest?.name ?? 'æœªå‘½åæ•°æ®åŒ…' }}</text>
				</view>
				<view class="info-row">
					<text class="info-label">ç‰ˆæœ¬</text>
					<text class="info-value">{{ manifest?.version ?? 'æœªçŸ¥ç‰ˆæœ¬' }}</text>
				</view>
				<view class="info-row">
					<text class="info-label">æè¿°</text>
					<text class="info-value">{{ manifest?.description ?? 'æ— æè¿°' }}</text>
				</view>
				<view class="info-row">
					<text class="info-label">æ—¶é—´</text>
					<text class="info-value">{{ formatTime(manifest?.exportTime) }}</text>
				</view>
			</view>
		</view>
		
		<!-- å¯¼å…¥è¿›åº¦ -->
		<view class="card progress-section" v-if="isImporting">
			<view class="progress-header">
				<text class="progress-title">æ­£åœ¨å¯¼å…¥...</text>
				<text class="progress-percent">{{ Math.floor((importProgress.current / importProgress.total) * 100) }}%</text>
			</view>
			<view class="progress-track">
				<view class="progress-fill" :style="{ width: (importProgress.current / importProgress.total) * 100 + '%' }"></view>
			</view>
			<text class="progress-status">{{ importProgress.status || 'æ­£åœ¨å¤„ç†æ•°æ®...' }}</text>
		</view>
		
		<!-- å¯¼å…¥ç»“æœ -->
		<view class="result-section" v-if="importResult != null">
			<view class="result-card" :class="importResult!.success ? 'result-success' : 'result-error'">
				<text class="result-icon-large">{{ importResult!.success ? 'âœ“' : 'âœ•' }}</text>
				<text class="result-title">{{ importResult!.success ? 'å¯¼å…¥å®Œæˆ' : 'å¯¼å…¥å¤±è´¥' }}</text>
				<text class="result-desc">{{ importResult!.message }}</text>
				<text class="result-stats" v-if="importResult!.success">
					æˆåŠŸå¯¼å…¥ {{ importResult!.processCount }} æ¡æ•°æ®ï¼Œè€—æ—¶ {{ (importResult!.importTime / 1000).toFixed(1) }}ç§’
				</text>
			</view>
		</view>
		
		<!-- æ“ä½œæŒ‰é’® -->
		<view class="action-footer">
			<button 
				class="btn-primary" 
				hover-class="btn-hover"
				:disabled="packageInfo.fileName == '' || isImporting"
				@click="handleImport"
				v-if="!importResult?.success"
			>
				<text class="btn-text">{{ isImporting ? 'æ­£åœ¨å¯¼å…¥...' : 'å¼€å§‹å¯¼å…¥' }}</text>
			</button>
			
			<button 
				class="btn-success" 
				hover-class="btn-hover"
				v-if="importResult?.success"
				@click="handleViewProcess"
			>
				<text class="btn-text">æŸ¥çœ‹å·¥è‰ºåˆ—è¡¨</text>
			</button>
		</view>
	</view>
<!-- #ifdef APP -->
</scroll-view>
<!-- #endif -->
</template>

<script setup lang="uts">
	import { PackageManifest, ImportProgress, ImportResult, PackageInfo } from '@/types/data-package.uts'
	import { selectPackageFile, validatePackage, importPackage, ImportProgressCallback } from '@/services/dataPackage.uts'
	import { initDatabase } from '@/services/database.uts'
	
	// çŠ¶æ€å®šä¹‰
	const packageInfo = reactive({
		fileName: '',
		fileSize: 0,
		manifest: null as PackageManifest | null,
		isValid: false,
		errorMessage: ''
	} as PackageInfo)
	
	const manifest = ref<PackageManifest | null>(null)
	const isImporting = ref(false)
	const isDbReady = ref(false)
	
	const importProgress = reactive({
		current: 0,
		total: 100,
		currentFile: '',
		status: ''
	} as ImportProgress)
	
	const importResult = ref<ImportResult | null>(null)
	
	// ç”Ÿå‘½å‘¨æœŸ
	onLoad(() => {
		initDb()
	})
	
	/**
	 * åˆå§‹åŒ–æ•°æ®åº“
	 */
	const initDb = () => {
		initDatabase()
			.then(() => {
				isDbReady.value = true
				console.log('æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ')
			})
			.catch((e: Error) => {
				console.error('æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥ï¼š', e.message)
				uni.showToast({
					title: 'æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥',
					icon: 'none'
				})
			})
	}
	
	/**
	 * é€‰æ‹©æ–‡ä»¶
	 */
	const handleSelectFile = () => {
		if (isImporting.value) return
		
		// é‡ç½®ç»“æœ
		importResult.value = null
		
		selectPackageFile()
			.then((info: PackageInfo) => {
				// æ›´æ–°åŸºæœ¬ä¿¡æ¯
				packageInfo.fileName = info.fileName
				packageInfo.fileSize = info.fileSize
				packageInfo.manifest = info.manifest
				packageInfo.isValid = info.isValid
				packageInfo.errorMessage = info.errorMessage
				
				uni.showLoading({ title: 'è§£ææ•°æ®åŒ…...' })
				
				validatePackage('')
					.then((manifestRes: PackageManifest) => {
						uni.hideLoading()
						manifest.value = manifestRes
						packageInfo.manifest = manifestRes
						packageInfo.isValid = true
					})
					.catch((e: Error) => {
						uni.hideLoading()
						packageInfo.isValid = false
						packageInfo.errorMessage = e.message
						uni.showToast({
							title: 'æ•°æ®åŒ…éªŒè¯å¤±è´¥',
							icon: 'none'
						})
					})
			})
			.catch((e: Error) => {
				console.error('é€‰æ‹©æ–‡ä»¶å¤±è´¥ï¼š', e.message)
			})
	}
	
	/**
	 * å¼€å§‹å¯¼å…¥
	 */
	const handleImport = () => {
		if (!isDbReady.value) {
			uni.showToast({ title: 'æ•°æ®åº“æœªå°±ç»ª', icon: 'none' })
			return
		}
		
		if (packageInfo.fileName == '') {
			uni.showToast({ title: 'è¯·å…ˆé€‰æ‹©æ•°æ®åŒ…', icon: 'none' })
			return
		}
		
		isImporting.value = true
		importResult.value = null
		
		const onProgress: ImportProgressCallback = (progress: ImportProgress) => {
			importProgress.current = progress.current
			importProgress.total = progress.total
			importProgress.currentFile = progress.currentFile
			importProgress.status = progress.status
		}
		
		importPackage('', onProgress)
			.then((result: ImportResult) => {
				isImporting.value = false
				importResult.value = result
				
				if (result.success) {
					uni.showToast({ title: 'å¯¼å…¥æˆåŠŸ', icon: 'success' })
				}
			})
			.catch((e: Error) => {
				isImporting.value = false
				importResult.value = {
					success: false,
					message: e.message,
					processCount: 0,
					uiConfigCount: 0,
					resourceCount: 0,
					importTime: 0
				}
				uni.showToast({ title: 'å¯¼å…¥å¤±è´¥', icon: 'none' })
			})
	}
	
	/**
	 * æŸ¥çœ‹å·¥è‰ºåˆ—è¡¨
	 */
	const handleViewProcess = () => {
		uni.navigateTo({ url: '/pages/process/list' })
	}
	
	/**
	 * æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
	 */
	const formatFileSize = (size: number): string => {
		if (size < 1024) return size.toString() + ' B'
		if (size < 1024 * 1024) return (size / 1024).toFixed(2) + ' KB'
		return (size / 1024 / 1024).toFixed(2) + ' MB'
	}
	
	/**
	 * æ ¼å¼åŒ–æ—¶é—´
	 */
	const formatTime = (isoTime: string | null): string => {
		if (isoTime == null) return 'æœªçŸ¥æ—¶é—´'
		try {
			const date = new Date(isoTime)
			const year = date.getFullYear()
			if (Number.isNaN(year)) return 'æ— æ•ˆæ—¶é—´'
			
			const month = (date.getMonth() + 1).toString().padStart(2, '0')
			const day = date.getDate().toString().padStart(2, '0')
			const hour = date.getHours().toString().padStart(2, '0')
			const minute = date.getMinutes().toString().padStart(2, '0')
			return `${year}-${month}-${day} ${hour}:${minute}`
		} catch (e) {
			return 'æ— æ•ˆæ—¶é—´'
		}
	}
</script>

<style>
	.page-container {
		flex: 1;
		background-color: #f7f9fc;
	}
	
	.import-page {
		flex-direction: column;
		padding: 24px 20px;
	}
	
	/* é¡µé¢å¤´éƒ¨ */
	.page-header {
		margin-bottom: 32px;
		margin-top: 10px;
	}
	
	.page-title {
		font-size: 28px;
		font-weight: 700;
		color: #1a1a1a;
		margin-bottom: 8px;
	}
	
	.page-subtitle {
		font-size: 15px;
		color: #8899a6;
	}
	
	/* å¡ç‰‡é€šç”¨æ ·å¼ */
	.card {
		background-color: #ffffff;
		border-radius: 16px;
		padding: 20px;
		margin-bottom: 20px;
		box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
	}
	
	.card-title {
		font-size: 16px;
		font-weight: 600;
		color: #1a1a1a;
		margin-bottom: 16px;
		padding-left: 8px;
		border-left-width: 3px;
		border-left-style: solid;
		border-left-color: #007aff;
	}
	
	/* æ–‡ä»¶é€‰æ‹©å™¨ */
	.file-picker {
		background-color: #ffffff;
		border-radius: 20px;
		padding: 30px 20px;
		margin-bottom: 24px;
		border-width: 2px;
		border-style: dashed;
		border-color: #e1e4e8;
		transition-property: background-color, border-color;
		transition-duration: 0.2s;
	}
	
	.file-picker-hover {
		background-color: #f0f7ff;
		border-color: #007aff;
	}
	
	.file-picker-content {
		align-items: center;
	}
	
	.icon-circle {
		width: 64px;
		height: 64px;
		background-color: #f5f7fa;
		border-radius: 32px;
		align-items: center;
		justify-content: center;
		margin-bottom: 16px;
	}
	
	.file-picker-icon {
		font-size: 32px;
	}
	
	.file-picker-title {
		font-size: 17px;
		font-weight: 600;
		color: #333;
		margin-bottom: 6px;
	}
	
	.file-picker-hint {
		font-size: 13px;
		color: #999;
	}
	
	/* æ–‡ä»¶ä¿¡æ¯çŠ¶æ€ */
	.file-info {
		flex-direction: row;
		align-items: center;
		width: 100%;
	}
	
	.file-icon-wrapper {
		width: 48px;
		height: 48px;
		background-color: #ebf5ff;
		border-radius: 12px;
		align-items: center;
		justify-content: center;
		margin-right: 16px;
	}
	
	.file-type-icon {
		color: #007aff;
		font-size: 14px;
		font-weight: 700;
	}
	
	.file-details {
		flex: 1;
		flex-direction: column;
	}
	
	.file-name {
		font-size: 16px;
		color: #333;
		font-weight: 600;
		margin-bottom: 4px;
	}
	
	.file-size {
		font-size: 13px;
		color: #888;
	}
	
	.file-change-badge {
		font-size: 12px;
		color: #007aff;
		background-color: #f0f7ff;
		padding: 6px 12px;
		border-radius: 100px;
	}
	
	/* è¯¦ç»†ä¿¡æ¯è¡¨æ ¼ */
	.info-grid {
		flex-direction: column;
	}
	
	.info-row {
		flex-direction: row;
		justify-content: space-between;
		padding: 12px 0;
		border-bottom-width: 1px;
		border-bottom-style: solid;
		border-bottom-color: #f5f7fa;
	}
	
	.info-label {
		color: #666;
		font-size: 14px;
	}
	
	.info-value {
		color: #333;
		font-size: 14px;
		font-weight: 500;
	}
	
	/* è¿›åº¦æ¡æ ·å¼ */
	.progress-section {
		flex-direction: column;
	}
	
	.progress-header {
		flex-direction: row;
		justify-content: space-between;
		margin-bottom: 12px;
	}
	
	.progress-title {
		font-size: 14px;
		color: #333;
		font-weight: 600;
	}
	
	.progress-percent {
		font-size: 14px;
		color: #007aff;
		font-weight: 700;
	}
	
	.progress-track {
		height: 8px;
		background-color: #eff3f6;
		border-radius: 100px;
		overflow: hidden;
		margin-bottom: 12px;
	}
	
	.progress-fill {
		height: 100%;
		background-color: #007aff;
		border-radius: 100px;
	}
	
	.progress-status {
		font-size: 12px;
		color: #8899a6;
		text-align: center;
	}
	
	/* ç»“æœå±•ç¤º */
	.result-section {
		margin-bottom: 80px;
	}
	
	.result-card {
		padding: 32px 24px;
		border-radius: 20px;
		align-items: center;
		flex-direction: column;
	}
	
	.result-success {
		background-color: #f0fdf4;
		border-width: 1px;
		border-style: solid;
		border-color: #dcfce7;
	}
	
	.result-error {
		background-color: #fef2f2;
		border-width: 1px;
		border-style: solid;
		border-color: #fee2e2;
	}
	
	.result-icon-large {
		font-size: 48px;
		margin-bottom: 16px;
		color: #16a34a; 
	}
	
	.result-error .result-icon-large {
		color: #dc2626;
	}
	
	.result-title {
		font-size: 20px;
		font-weight: 700;
		color: #1a1a1a;
		margin-bottom: 8px;
	}
	
	.result-desc {
		font-size: 15px;
		color: #4b5563;
		text-align: center;
		margin-bottom: 16px;
	}
	
	.result-stats {
		font-size: 13px;
		color: #6b7280;
		background-color: rgba(255,255,255,0.6);
		padding: 8px 16px;
		border-radius: 100px;
	}
	
	/* æŒ‰é’®åŒºåŸŸ */
	.action-footer {
		position: fixed;
		bottom: 0;
		left: 0;
		right: 0;
		background-color: #ffffff;
		padding: 16px 20px;
		padding-bottom: 30px;
		border-top-width: 1px;
		border-top-style: solid;
		border-top-color: #f0f0f0;
	}
	
	.btn-primary {
		background-color: #007aff;
		border-radius: 50px;
		height: 48px;
		justify-content: center;
		align-items: center;
		border-width: 0;
	}
	
	.btn-success {
		background-color: #10b981;
		border-radius: 50px;
		height: 48px;
		justify-content: center;
		align-items: center;
		border-width: 0;
	}
	
	.btn-hover {
		opacity: 0.9;
		transform: scale(0.98);
	}
	
	.btn-text {
		color: #fff;
		font-size: 16px;
		font-weight: 600;
	}
</style>
