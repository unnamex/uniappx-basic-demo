<template>
	<!-- #ifdef APP -->
	<scroll-view class="page-container">
	<!-- #endif -->
	<view class="import-page">
		<!-- é¡µé¢å¤´éƒ¨ -->
		<view class="page-header">
			<text class="page-title">æ•°æ®åŒ…å¯¼å…¥</text>
			<text class="page-subtitle">ä» SRD ç³»ç»Ÿå¯¼å‡ºçš„å·¥è‰ºæ•°æ®åŒ…</text>
		</view>
		
		<!-- æ–‡ä»¶é€‰æ‹©åŒºåŸŸ -->
		<view class="file-picker" @click="handleSelectFile">
			<view class="file-picker-content" v-if="!packageInfo.fileName">
				<text class="file-picker-icon">ğŸ“¦</text>
				<text class="file-picker-text">ç‚¹å‡»é€‰æ‹© .srd æ•°æ®åŒ…æ–‡ä»¶</text>
				<text class="file-picker-hint">æ”¯æŒä»è®¾å¤‡å­˜å‚¨ä¸­é€‰æ‹©æ–‡ä»¶</text>
			</view>
			<view class="file-info" v-else>
				<text class="file-name">{{ packageInfo.fileName }}</text>
				<text class="file-size">{{ formatFileSize(packageInfo.fileSize) }}</text>
				<text class="file-change-btn">é‡æ–°é€‰æ‹©</text>
			</view>
		</view>
		
		<!-- æ•°æ®åŒ…ä¿¡æ¯é¢„è§ˆ -->
		<view class="package-info" v-if="manifest != null">
			<view class="info-header">
				<text class="info-title">æ•°æ®åŒ…ä¿¡æ¯</text>
			</view>
			<view class="info-item">
				<text class="info-label">æ¥æºç³»ç»Ÿ</text>
				<text class="info-value">{{ manifest.source }}</text>
			</view>
			<view class="info-item">
				<text class="info-label">å¯¼å‡ºæ—¶é—´</text>
				<text class="info-value">{{ formatTime(manifest.exportTime) }}</text>
			</view>
			<view class="info-item">
				<text class="info-label">å·¥è‰ºæ•°é‡</text>
				<text class="info-value">{{ manifest.processCount }} æ¡</text>
			</view>
			<view class="info-item">
				<text class="info-label">ç‰ˆæœ¬</text>
				<text class="info-value">{{ manifest.version }}</text>
			</view>
		</view>
		
	/* å¯¼å…¥è¿›åº¦ */
	.progress-section {
		background-color: #ffffff;
		border-radius: 12px;
		padding: 20px;
		margin-bottom: 20px;
		align-items: center;
	}
		
		<!-- å¯¼å…¥ç»“æœ -->
		<view class="result-section" v-if="importResult != null">
			<view class="result-icon-container" :class="importResult.success ? 'success' : 'error'">
				<text class="result-icon">{{ importResult.success ? 'âœ“' : 'âœ•' }}</text>
			</view>
			<text class="result-message">{{ importResult.message }}</text>
			<text class="result-detail" v-if="importResult.success">
				æˆåŠŸå¯¼å…¥ {{ importResult.processCount }} æ¡å·¥è‰ºæ•°æ®ï¼Œè€—æ—¶ {{ importResult.importTime }} ms
			</text>
		</view>
		
		<!-- æ“ä½œæŒ‰é’® -->
		<view class="action-buttons">
			<button 
				:class="packageInfo.fileName == '' || isImporting ? 'btn-import btn-import-disabled' : 'btn-import'" 
				:disabled="packageInfo.fileName == '' || isImporting"
				@click="handleImport"
			>
				<text class="btn-text">{{ isImporting ? 'å¯¼å…¥ä¸­...' : 'å¼€å§‹å¯¼å…¥' }}</text>
			</button>
			
			<button 
				class="btn-view" 
				v-if="importResult != null && importResult.success"
				@click="handleViewProcess"
			>
				<text class="btn-text">æŸ¥çœ‹å·¥è‰ºåˆ—è¡¨</text>
			</button>
		</view>
	</view>
<!-- #ifdef APP -->
</scroll-view>
<!-- #endif -->
</template>

<script lang="uts">
	import { PackageManifest, ImportProgress, ImportResult, PackageInfo } from '@/types/data-package.uts'
	import { selectPackageFile, validatePackage, importPackage, ImportProgressCallback } from '@/services/dataPackage.uts'
	import { initDatabase } from '@/services/database.uts'
	
	export default {
		data() {
			return {
				// æ•°æ®åŒ…ä¿¡æ¯
				packageInfo: {
					fileName: '',
					fileSize: 0,
					manifest: null,
					isValid: false,
					errorMessage: ''
				} as PackageInfo,
				
				// æ¸…å•ä¿¡æ¯
				manifest: null as PackageManifest | null,
				
				// å¯¼å…¥çŠ¶æ€
				isImporting: false,
				
				// å¯¼å…¥è¿›åº¦
				importProgress: {
					current: 0,
					total: 100,
					currentFile: '',
					status: ''
				} as ImportProgress,
				
				// å¯¼å…¥ç»“æœ
				importResult: null as ImportResult | null,
				
				// æ•°æ®åº“æ˜¯å¦å·²åˆå§‹åŒ–
				isDbReady: false
			}
		},
		
		onLoad() {
			// åˆå§‹åŒ–æ•°æ®åº“
			this.initDb()
		},
		
		methods: {
			/**
			 * åˆå§‹åŒ–æ•°æ®åº“
			 */
			initDb() {
				initDatabase()
					.then(() => {
						this.isDbReady = true
						console.log('æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ')
					})
					.catch((e: Error) => {
						console.error('æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥ï¼š', e.message)
						uni.showToast({
							title: 'æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥',
							icon: 'none'
						})
					})
			},
			
			/**
			 * é€‰æ‹©æ–‡ä»¶
			 */
			handleSelectFile() {
				if (this.isImporting) {
					return
				}
				
				// é‡ç½®çŠ¶æ€
				this.importResult = null
				
				selectPackageFile()
					.then((info: PackageInfo) => {
						this.packageInfo = info
						
						// é¢„è§ˆæ•°æ®åŒ…å†…å®¹
						uni.showLoading({ title: 'è§£ææ•°æ®åŒ…...' })
						
						validatePackage('')
							.then((manifest: PackageManifest) => {
								uni.hideLoading()
								this.manifest = manifest
								this.packageInfo.manifest = manifest
								this.packageInfo.isValid = true
							})
							.catch((e: Error) => {
								uni.hideLoading()
								this.packageInfo.isValid = false
								this.packageInfo.errorMessage = e.message
								uni.showToast({
									title: 'æ•°æ®åŒ…éªŒè¯å¤±è´¥',
									icon: 'none'
								})
							})
					})
					.catch((e: Error) => {
						console.error('é€‰æ‹©æ–‡ä»¶å¤±è´¥ï¼š', e.message)
					})
			},
			
			/**
			 * å¼€å§‹å¯¼å…¥
			 */
			handleImport() {
				if (!this.isDbReady) {
					uni.showToast({
						title: 'æ•°æ®åº“æœªå°±ç»ª',
						icon: 'none'
					})
					return
				}
				
				if (this.packageInfo.fileName == '') {
					uni.showToast({
						title: 'è¯·å…ˆé€‰æ‹©æ•°æ®åŒ…',
						icon: 'none'
					})
					return
				}
				
				this.isImporting = true
				this.importResult = null
				
				// è¿›åº¦å›è°ƒ
				const onProgress: ImportProgressCallback = (progress: ImportProgress) => {
					this.importProgress = progress
				}
				
				importPackage('', onProgress)
					.then((result: ImportResult) => {
						this.isImporting = false
						this.importResult = result
						
						if (result.success) {
							uni.showToast({
								title: 'å¯¼å…¥æˆåŠŸ',
								icon: 'success'
							})
						}
					})
					.catch((e: Error) => {
						this.isImporting = false
						this.importResult = {
							success: false,
							message: e.message,
							processCount: 0,
							uiConfigCount: 0,
							resourceCount: 0,
							importTime: 0
						}
						
						uni.showToast({
							title: 'å¯¼å…¥å¤±è´¥',
							icon: 'none'
						})
					})
			},
			
			/**
			 * æŸ¥çœ‹å·¥è‰ºåˆ—è¡¨
			 */
			handleViewProcess() {
				uni.navigateTo({
					url: '/pages/process/list'
				})
			},
			
			/**
			 * æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
			 */
			formatFileSize(size: number): string {
				if (size < 1024) {
					return size.toString() + ' B'
				} else if (size < 1024 * 1024) {
					return (size / 1024).toFixed(2) + ' KB'
				} else {
					return (size / 1024 / 1024).toFixed(2) + ' MB'
				}
			},
			
			/**
			 * æ ¼å¼åŒ–æ—¶é—´
			 */
			formatTime(isoTime: string): string {
				const date = new Date(isoTime)
				const year = date.getFullYear()
				const month = (date.getMonth() + 1).toString().padStart(2, '0')
				const day = date.getDate().toString().padStart(2, '0')
				const hour = date.getHours().toString().padStart(2, '0')
				const minute = date.getMinutes().toString().padStart(2, '0')
				return `${year}-${month}-${day} ${hour}:${minute}`
			}
		}
	}
</script>

<style>
	.page-container {
		flex: 1;
		background-color: #f5f6f7;
	}
	
	.import-page {
		flex-direction: column;
		padding: 20px;
	}
	
	/* é¡µé¢å¤´éƒ¨ */
	.page-header {
		flex-direction: column;
		align-items: center;
		margin-bottom: 30px;
	}
	
	.page-title {
		font-size: 24px;
		font-weight: bold;
		color: #333333;
	}
	
	.page-subtitle {
		font-size: 14px;
		color: #999999;
		margin-top: 8px;
	}
	
	/* æ–‡ä»¶é€‰æ‹©åŒºåŸŸ */
	.file-picker {
		background-color: #ffffff;
		border-radius: 12px;
		padding: 30px;
		align-items: center;
		justify-content: center;
		border-width: 2px;
		border-style: dashed;
		border-color: #e0e0e0;
		margin-bottom: 20px;
	}
	
	.file-picker-content {
		flex-direction: column;
		align-items: center;
	}
	
	.file-picker-icon {
		font-size: 48px;
		margin-bottom: 16px;
	}
	
	.file-picker-text {
		font-size: 16px;
		color: #333333;
		margin-bottom: 8px;
	}
	
	.file-picker-hint {
		font-size: 12px;
		color: #999999;
	}
	
	.file-info {
		flex-direction: column;
		align-items: center;
	}
	
	.file-name {
		font-size: 16px;
		color: #333333;
		font-weight: bold;
	}
	
	.file-size {
		font-size: 14px;
		color: #666666;
		margin-top: 4px;
	}
	
	.file-change-btn {
		font-size: 14px;
		color: #007aff;
		margin-top: 12px;
	}
	
	/* æ•°æ®åŒ…ä¿¡æ¯ */
	.package-info {
		background-color: #ffffff;
		border-radius: 12px;
		padding: 20px;
		margin-bottom: 20px;
	}
	
	.info-header {
		margin-bottom: 16px;
	}
	
	.info-title {
		font-size: 16px;
		font-weight: bold;
		color: #333333;
	}
	
	.info-item {
		flex-direction: row;
		justify-content: space-between;
		padding: 10px 0;
		border-bottom-width: 1px;
		border-bottom-style: solid;
		border-bottom-color: #f0f0f0;
	}
	
	.info-label {
		font-size: 14px;
		color: #666666;
	}
	
	.info-value {
		font-size: 14px;
		color: #333333;
	}
	
	/* è¿›åº¦æ¡ */
	.progress-section {
		background-color: #ffffff;
		border-radius: 12px;
		padding: 20px;
		margin-bottom: 20px;
		align-items: center;
	}
	
	.progress-label {
		font-size: 14px;
		color: #666666;
		margin-bottom: 12px;
	}
	
	.progress-bar-container {
		width: 100%;
		height: 8px;
		background-color: #f0f0f0;
		border-radius: 4px;
		overflow: hidden;
	}
	
	.progress-bar {
		height: 8px;
		background-color: #007aff;
		border-radius: 4px;
	}
	
	.progress-percent {
		font-size: 14px;
		color: #333333;
		margin-top: 8px;
	}
	
	/* å¯¼å…¥ç»“æœ */
	.result-section {
		background-color: #ffffff;
		border-radius: 12px;
		padding: 30px;
		margin-bottom: 20px;
		align-items: center;
	}
	
	.result-icon-container {
		width: 60px;
		height: 60px;
		border-radius: 30px;
		align-items: center;
		justify-content: center;
		margin-bottom: 16px;
	}
	
	.result-icon-container.success {
		background-color: #4cd964;
	}
	
	.result-icon-container.error {
		background-color: #ff3b30;
	}
	
	.result-icon {
		font-size: 32px;
		color: #ffffff;
	}
	
	.result-message {
		font-size: 18px;
		font-weight: bold;
		color: #333333;
	}
	
	.result-detail {
		font-size: 14px;
		color: #666666;
		margin-top: 8px;
		text-align: center;
	}
	
	/* æŒ‰é’® */
	.action-buttons {
		flex-direction: column;
		margin-top: 20px;
	}
	
	.btn-import {
		background-color: #007aff;
		border-radius: 8px;
		height: 50px;
		align-items: center;
		justify-content: center;
		margin-bottom: 12px;
	}
	
	.btn-import-disabled {
		background-color: #cccccc;
	}
	
	.btn-view {
		background-color: #4cd964;
		border-radius: 8px;
		height: 50px;
		align-items: center;
		justify-content: center;
	}
	
	.btn-text {
		color: #ffffff;
		font-size: 16px;
		font-weight: bold;
	}
</style>
