<template>
	<view class="resource-preview">
		<!-- æ— èµ„æºçŠ¶æ€ -->
		<view v-if="resource == null" class="empty-state">
			<text class="empty-icon">ğŸ“‚</text>
			<text class="empty-text">é€‰æ‹©èµ„æºè¿›è¡Œé¢„è§ˆ</text>
		</view>
		
		<!-- å›¾ç‰‡é¢„è§ˆ -->
		<view v-else-if="resource.type == 'image'" class="preview-container image-preview">
			<image 
				class="preview-image"
				:src="resource.path"
				mode="aspectFit"
				@error="onImageError"
			/>
			<view class="resource-info">
				<text class="resource-name">{{ resource.name }}</text>
				<text v-if="resource.description != ''" class="resource-desc">{{ resource.description }}</text>
			</view>
		</view>
		
		<!-- è§†é¢‘é¢„è§ˆ -->
		<view v-else-if="resource.type == 'video'" class="preview-container video-preview">
			<video
				class="preview-video"
				:src="resource.path"
				:poster="resource.thumbnail"
				controls
				:autoplay="false"
				object-fit="contain"
				@error="onVideoError"
				@timeupdate="onTimeUpdate"
				@ended="onEnded"
			/>
			<view class="resource-info">
				<text class="resource-name">{{ resource.name }}</text>
				<text v-if="resource.duration > 0" class="resource-duration">æ—¶é•¿: {{ formatTime(resource.duration) }}</text>
			</view>
		</view>
		
		<!-- éŸ³é¢‘é¢„è§ˆ -->
		<view v-else-if="resource.type == 'audio'" class="preview-container audio-preview">
			<view class="audio-visual">
				<text class="audio-icon">ğŸµ</text>
				<view class="audio-wave">
					<view v-for="i in 5" :key="i" class="wave-bar" :class="{ 'playing': isPlaying }"></view>
				</view>
			</view>
			<view class="audio-controls">
				<button class="audio-btn" @click="toggleAudio">
					<text>{{ isPlaying ? 'â¸ï¸' : 'â–¶ï¸' }}</text>
				</button>
				<view class="audio-progress">
					<view class="progress-bar">
						<view class="progress-fill" :style="{ width: progressPercent + '%' }"></view>
					</view>
					<text class="time-text">{{ formatTime(currentTime) }} / {{ formatTime(resource.duration) }}</text>
				</view>
			</view>
			<view class="resource-info">
				<text class="resource-name">{{ resource.name }}</text>
			</view>
		</view>
		
		<!-- æ–‡æ¡£é¢„è§ˆ -->
		<view v-else-if="resource.type == 'document'" class="preview-container document-preview">
			<view class="document-icon-wrap">
				<text class="document-icon">ğŸ“„</text>
			</view>
			<view class="resource-info">
				<text class="resource-name">{{ resource.name }}</text>
				<text class="resource-hint">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ‰“å¼€æ–‡æ¡£</text>
			</view>
			<button class="open-btn" @click="openDocument">
				<text class="btn-text">æ‰“å¼€æ–‡æ¡£</text>
			</button>
		</view>
		
		<!-- æœªçŸ¥ç±»å‹ -->
		<view v-else class="preview-container unknown-preview">
			<text class="unknown-icon">â“</text>
			<text class="unknown-text">ä¸æ”¯æŒé¢„è§ˆæ­¤ç±»å‹æ–‡ä»¶</text>
			<text class="resource-name">{{ resource.name }}</text>
		</view>
	</view>
</template>

<script setup lang="uts">
	import { ResourceItem, formatDuration } from '@/types/resource'
	
	// Props
	const props = defineProps<{
		resource: ResourceItem | null
	}>()
	
	// Emits
	const emit = defineEmits<{
		(e: 'error', message: string): void
		(e: 'loaded'): void
	}>()
	
	// éŸ³é¢‘æ’­æ”¾çŠ¶æ€
	const isPlaying = ref(false)
	const currentTime = ref(0)
	const audioContext = ref<any>(null)
	
	// è¿›åº¦ç™¾åˆ†æ¯”
	const progressPercent = computed((): number => {
		if (props.resource == null || props.resource.duration <= 0) return 0
		return (currentTime.value / props.resource.duration) * 100
	})
	
	// æ ¼å¼åŒ–æ—¶é—´
	const formatTime = (seconds: number): string => {
		return formatDuration(seconds)
	}
	
	// å›¾ç‰‡åŠ è½½é”™è¯¯
	const onImageError = (e: any) => {
		console.error('Image load error:', e)
		emit('error', 'å›¾ç‰‡åŠ è½½å¤±è´¥')
	}
	
	// è§†é¢‘åŠ è½½é”™è¯¯
	const onVideoError = (e: any) => {
		console.error('Video load error:', e)
		emit('error', 'è§†é¢‘åŠ è½½å¤±è´¥')
	}
	
	// è§†é¢‘æ—¶é—´æ›´æ–°
	const onTimeUpdate = (e: any) => {
		currentTime.value = e.detail?.currentTime ?? 0
	}
	
	// æ’­æ”¾ç»“æŸ
	const onEnded = () => {
		isPlaying.value = false
		currentTime.value = 0
	}
	
	// åˆ‡æ¢éŸ³é¢‘æ’­æ”¾
	const toggleAudio = () => {
		if (props.resource == null) return
		
		// #ifdef WEB
		if (audioContext.value == null) {
			audioContext.value = new Audio(props.resource.path)
			audioContext.value.ontimeupdate = () => {
				currentTime.value = audioContext.value.currentTime
			}
			audioContext.value.onended = () => {
				isPlaying.value = false
				currentTime.value = 0
			}
		}
		
		if (isPlaying.value) {
			audioContext.value.pause()
		} else {
			audioContext.value.play()
		}
		isPlaying.value = !isPlaying.value
		// #endif
		
		// #ifndef WEB
		// App ç«¯ä½¿ç”¨ uni.createInnerAudioContext
		if (audioContext.value == null) {
			audioContext.value = uni.createInnerAudioContext()
			audioContext.value.src = props.resource!.path
			audioContext.value.onTimeUpdate(() => {
				currentTime.value = audioContext.value.currentTime
			})
			audioContext.value.onEnded(() => {
				isPlaying.value = false
				currentTime.value = 0
			})
		}
		
		if (isPlaying.value) {
			audioContext.value.pause()
		} else {
			audioContext.value.play()
		}
		isPlaying.value = !isPlaying.value
		// #endif
	}
	
	// æ‰“å¼€æ–‡æ¡£
	const openDocument = () => {
		if (props.resource == null) return
		
		// #ifdef APP-ANDROID
		uni.openDocument({
			filePath: props.resource.path,
			fail: (err: any) => {
				uni.showToast({
					title: 'æ— æ³•æ‰“å¼€æ–‡æ¡£',
					icon: 'none'
				})
			}
		})
		// #endif
		
		// #ifdef WEB
		window.open(props.resource.path, '_blank')
		// #endif
	}
	
	// ç›‘å¬èµ„æºå˜åŒ–ï¼Œé‡ç½®çŠ¶æ€
	watch(() => props.resource, (newVal: ResourceItem | null) => {
		// åœæ­¢å½“å‰æ’­æ”¾
		if (audioContext.value != null) {
			// #ifdef WEB
			audioContext.value.pause()
			audioContext.value = null
			// #endif
			
			// #ifndef WEB
			audioContext.value.stop()
			audioContext.value.destroy()
			audioContext.value = null
			// #endif
		}
		
		isPlaying.value = false
		currentTime.value = 0
	})
	
	// ç»„ä»¶å¸è½½æ—¶æ¸…ç†
	onUnmounted(() => {
		if (audioContext.value != null) {
			// #ifdef WEB
			audioContext.value.pause()
			// #endif
			
			// #ifndef WEB
			audioContext.value.stop()
			audioContext.value.destroy()
			// #endif
		}
	})
</script>

<style>
	.resource-preview {
		flex: 1;
		display: flex;
		flex-direction: column;
		background-color: #fff;
		border-radius: 8px;
		overflow: hidden;
		border: 1px solid #e0e0e0;
	}
	
	/* ç©ºçŠ¶æ€ */
	.empty-state {
		flex: 1;
		display: flex;
		flex-direction: column;
		justify-content: center;
		align-items: center;
	}
	
	.empty-icon {
		font-size: 48px;
		margin-bottom: 12px;
	}
	
	.empty-text {
		font-size: 14px;
		color: #666;
	}
	
	/* é¢„è§ˆå®¹å™¨ */
	.preview-container {
		flex: 1;
		display: flex;
		flex-direction: column;
		padding: 12px;
	}
	
	/* å›¾ç‰‡é¢„è§ˆ */
	.image-preview {
		justify-content: center;
		align-items: center;
	}
	
	.preview-image {
		flex: 1;
		width: 100%;
		max-height: 300px;
		border-radius: 4px;
	}
	
	/* è§†é¢‘é¢„è§ˆ */
	.video-preview {
		justify-content: flex-start;
	}
	
	.preview-video {
		width: 100%;
		height: 200px;
		border-radius: 4px;
		background-color: #000;
	}
	
	/* éŸ³é¢‘é¢„è§ˆ */
	.audio-preview {
		justify-content: center;
		align-items: center;
	}
	
	.audio-visual {
		display: flex;
		flex-direction: column;
		align-items: center;
		margin-bottom: 20px;
	}
	
	.audio-icon {
		font-size: 64px;
		margin-bottom: 16px;
	}
	
	.audio-wave {
		display: flex;
		flex-direction: row;
		align-items: flex-end;
		height: 40px;
	}
	
	.wave-bar {
		width: 6px;
		height: 20px;
		background-color: #4a90e2;
		margin: 0 3px;
		border-radius: 3px;
	}
	
	.wave-bar.playing {
		background-color: #52c41a;
	}
	
	.audio-controls {
		width: 100%;
		display: flex;
		flex-direction: row;
		align-items: center;
		padding: 0 20px;
	}
	
	.audio-btn {
		width: 48px;
		height: 48px;
		border-radius: 24px;
		background-color: #4a90e2;
		display: flex;
		justify-content: center;
		align-items: center;
		margin-right: 16px;
	}
	
	.audio-progress {
		flex: 1;
		display: flex;
		flex-direction: column;
	}
	
	.progress-bar {
		height: 6px;
		background-color: #333;
		border-radius: 3px;
		overflow: hidden;
	}
	
	.progress-fill {
		height: 100%;
		background-color: #4a90e2;
		border-radius: 3px;
	}
	
	.time-text {
		font-size: 12px;
		color: #999;
		margin-top: 4px;
	}
	
	/* æ–‡æ¡£é¢„è§ˆ */
	.document-preview {
		justify-content: center;
		align-items: center;
	}
	
	.document-icon-wrap {
		margin-bottom: 16px;
	}
	
	.document-icon {
		font-size: 64px;
	}
	
	.resource-hint {
		font-size: 12px;
		color: #888;
		margin-top: 4px;
	}
	
	.open-btn {
		margin-top: 20px;
		padding: 12px 32px;
		background-color: #4a90e2;
		border-radius: 6px;
	}
	
	.btn-text {
		font-size: 14px;
		color: #fff;
	}
	
	/* æœªçŸ¥ç±»å‹ */
	.unknown-preview {
		justify-content: center;
		align-items: center;
	}
	
	.unknown-icon {
		font-size: 48px;
		margin-bottom: 12px;
	}
	
	.unknown-text {
		font-size: 14px;
		color: #888;
		margin-bottom: 8px;
	}
	
	/* èµ„æºä¿¡æ¯ */
	.resource-info {
		margin-top: 12px;
		padding: 8px;
		display: flex;
		flex-direction: column;
		align-items: center;
	}
	
	.resource-name {
		font-size: 14px;
		color: #333;
		font-weight: 500;
	}
	
	.resource-desc {
		font-size: 12px;
		color: #666;
		margin-top: 4px;
	}
	
	.resource-duration {
		font-size: 12px;
		color: #4a90e2;
		margin-top: 4px;
	}
</style>
